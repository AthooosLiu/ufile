# 图片处理服务

图片处理服务是 UCloud 对外提供的海量、安全、低成本高可靠的图片处理服务。用户将原始图片上传保存在对象存储空间中，用户可以在任何时间、任何地点、任何设备上对图片进行处理。

图片处理服务仅在下载时触发。

图片处理服务提供以下功能：

- [imageinfo 图片基本信息](#imageinfo 图片基本信息)
- [exif EXIF信息](#exif EXIF信息)
- [thumbnail 图片缩放](#thumbnail 图片缩放)
- [下载文件或文件夹](#下载文件或文件夹)
- [拷贝文件或文件夹](#拷贝文件或文件夹)
- [删除文件或文件夹](#删除文件或文件夹)
- [查询文件基本信息](#查询文件基本信息)
- [文件基本信息修改](#文件基本信息修改)

## imageinfo 图片基本信息

图片基本信息包括图片格式、图片大小。

在图片下载 URL 后附加 imageinfo 指示符（区分大小写），即可获取 JSON 格式的图片基本信息。

### 参数

| 参数名 | 值 | 解释 |
| --- | --- | --- |
| iopcmd | imageinfo | 查看图片基本信息（高、宽、图片格式） |

### 使用示例

`?iopcmd=imageinfo`

## exif EXIF信息

EXIF（EXchangeable Image File Format）是专门为数码相机的照片设定的可交换图像文件格式，通过在图片下载 URL 后附加 exif 指示符（区分大小写）获取。

### 参数

| 参数名 | 值 | 解释 |
| --- | --- | --- |
| iopcmd | exif | 查看图片的EXIF信息（可交换图像文件格式 Exchangeable Image File Format） |

### 使用示例

`?iopcmd=exif`

### 备注

如果图片自身不包含EXIF信息，调用该命令将返回空json`{}`，缩略图等经过处理的新图片不支持该方法。

## thumbnail 图片缩放

### 参数

| 参数名 | 值 | 解释 |
| --- | --- | --- |
| iopcmd | thumbnail | 对图片进行缩放 |
| type | [1-15] | 缩放类型（详细请参考备注中type栏） |
| width | [1-10000] | 图片缩放后的宽度（像素） |
| height | [1-10000] | 图片缩放后的高度（像素） |
| scale | [1-10000] | 相较原图缩放的百分比，如果值为100则尺寸与原图相同 |
| color | 颜色名、RGB、RGBA | 缩放后留白部分的填充色，默认为白色（详细请参考备注中color栏）注意：使用RGBA需要图片格式支持alpha通道 |
| gifmode | [1-6] | GIF图片处理方式类型（详细请参考备注中gifmode栏） |
| giftimeout | [1-60] （默认为6） | GIF图片的最大处理时间，单位（秒）。（配合gifmode使用）|

### 使用示例

见备注中type与gifmode

### 备注

#### color

| color值类型 | 示例 | 描述 |
| --- | --- | --- |
| 颜色名称 | `color=red` | 红色，其它颜色名称可参考 [color names](https://www.imagemagick.org/script/color.php#color_names) |
| RGB | `color=rgb(255,0,0)` | 红色 |
| RGB 16进制 | `color=%23FF0000` | 红色 注意：URL中#符号为锚点，需要转义为%23 |
| RGBA | `color=rgba(0,255,0,0.5)` | 绿色半透明 |
| RGBA 16进制 | `color=%2300FF00FF` | 绿色不透明 注意：URL中#符号为锚点，需要转义为%23  |

#### type

| type参数值 | 描述 | 起效参数 | 示例 | 示例说明 |
| --- | --- | --- | --- | --- | 
| 1 | 按照比例缩放 | scale | `?iopcmd=thumbnail&type=1&scale=10` | 高度与宽度都缩放至原图的10% |
| 2 | 宽度与原图一致，高度按照设定的比例缩放 | scale | `?iopcmd=thumbnail&type=2&scale=10` | 宽度与原图一致，高度缩放至原图的10% |
| 3 | 高度与原图一致，宽度按照设定的比例缩放 | scale | `?iopcmd=thumbnail&type=3&scale=10` | 高度与原图一致，宽度缩放至原图的10% |
| 4 | 设定图片的宽度，高度根据原图的长宽比自动缩放 | width | `?iopcmd=thumbnail&type=4&width=50` | 宽度缩放至50像素，高度根据原图的长宽比自动缩放 |
| 5 | 设定图片的高度，宽度根据原图的长宽比自动缩放 | height | `?iopcmd=thumbnail&type=5&height=50` | 高度缩放至50像素，宽度根据原图的长宽比自动缩放 |
| 6 | 设定原图中较长边的长度，较短边根据比例自动缩放 | width height | `?iopcmd=thumbnail&type=6&height=10&width=50` | 假设原图尺寸为宽400像素，高300像素。宽较高更长，因此宽缩放至50像素，高则根据比例缩放至37像素 |
| 7 | 设定原图中较短边的长度，较长边根据比例自动缩放 | width height | `?iopcmd=thumbnail&type=7&height=10&width=50` | 假设原图尺寸为宽400像素，高300像素。高较宽更短，因此高缩放至10像素，宽则根据比例缩放至13像素 |
| 8 | 设定目标图像的高与宽，原图等比缩放至符合设定的最小尺寸，缩放之后的图片居中剪裁至设定的尺寸（高度没有指定时等于宽度，宽度没有指定时等于高度） | width height 或 width 或 height | `?iopcmd=thumbnail&type=8&width=50` | 假设原图尺寸为400像素宽，300像素高。仅指定宽度，因此高度=宽度=50像素。原图首先缩放至66像素宽，50像素高，之后居中裁剪至50x50像素尺寸。 |
| 9 | 指定目标矩形的高与宽，原图等比缩放至小于该指定矩形的最大尺寸 | width height | `?iopcmd=thumbnail&type=9&height=50&width=50` | 假设原图尺寸为400像素宽，300像素高。设定目标矩形为50x50像素，则原图将被缩放至50像素宽，37像素高。 |
| 10 | 指定目标矩形的高与宽，原图等比缩放至大于该指定矩形的最小尺寸 | width height | `?iopcmd=thumbnail&type=10&height=50&width=50` | 假设原图尺寸为400像素宽，300像素高。设定目标矩形为50x50，则原图将被缩放至66像素宽，50像素高。 |
| 11 | 指定图像的宽与高，原图缩放至目标尺寸。注意：可能会破坏原有图片的长宽比 | width height | `?iopcmd=thumbnail&type=11&height=50&width=50` | 假设原图尺寸为400像素宽，300像素高。原图将被缩放至50x50像素大小，图像的长宽比被改变。|
| 12 | 指定目标图像的宽和高，指定的数值需要大于原图的宽和高。原图居中放置，四周填充指定颜色。 | width height color | `?iopcmd=thumbnail&type=12&height=600&width=600&color=red` |   假设原图尺寸为400像素宽，300像素高。生成的图像尺寸为600x600，原图居中放置，四周填充红色 |
| 13 | 指定目标矩形的宽与高，原图先等比缩放至大于该目标矩形的最小尺寸，再根据目标矩形的尺寸进行居中裁剪 | width height | `?iopcmd=thumbnail&type=13&height=100&width=50` | 假设原图尺寸为400像素宽，300像素高。先缩放至133像素宽，100像素高，之后再居中裁剪至50像素宽，100像素高 |
| 14 | 同type=9 | - | `?iopcmd=thumbnail&type=14&height=50&width=50` | - |
| 15 | 指定目标矩形的高与宽，原图等比缩放至小于该指定矩形的最大尺寸，如果缩放后小于目标矩形，则空白部分填充颜色 | width height color |  `?iopcmd=thumbnail&type=15&height=50&width=50&color=red` | 假设原图尺寸为400像素宽，300像素高。先将原图缩放至50像素宽，37像素高。生成的图像尺寸为50x50像素，原图缩放后居中放置，不足的部分以红色填充。 | 

#### gifmode

| gifmode参数值 | 描述 | 起效参数 | 示例 | 示例描述 |
| --- | --- | --- | --- | --- |
| 1 | 缩放GIF动画，如果不能在设定时间内处理完全部帧，则返回已经处理完成的连续帧 | giftimeout | `?iopcmd=thumbnail&type=1&scale=10&gifmode=1&giftimeout=1` |缩放GIF动画至原先尺寸的10%，返回在1秒内处理完成的连续帧 |
| 2 | 返回缩放后GIF动画的第一帧 | - | `?iopcmd=thumbnail&type=1&scale=10&gifmode=2` | 返回GIF动画的第一帧，并且图像大小为原尺寸的10% |
| 3 | 同gifmode=1 | - | - | - |
| 4 | 缩放GIF动画，如果不能在设定时间内处理完全部帧，则返回间隔的帧。 | giftimeout | `?iopcmd=thumbnail&type=1&scale=10&gifmode=4` | 缩放GIF动画至原先尺寸的10%，返回在6秒（默认）内处理完成的间隔的帧。假设原图有6帧，6秒内只能处理3帧，那么将会返回处理完成的原图的第1、3、5帧。 |
| 5 | 缩放GIF动画，如果不能在设定时间内处理完全部帧，则返回间隔的帧，跳过的帧用之前的帧填补。总帧数与原图一致。 | giftimeout | `?iopcmd=thumbnail&type=1&scale=10&gifmode=5` | 缩放GIF动画至原先尺寸的10%，返回在6秒（默认）内处理完成的间隔的帧。假设原图有6帧，6秒内只能处理3帧，那么将会返回6帧，其中第1、2两帧为处理后的原图第1帧，第3、4两帧为处理后的原图第3帧，第5、6两帧为处理后的原图第5帧。 |
| 6 | 缩放GIF动画，如果不能在设定时间内处理完全部帧，则返回间隔的帧。 帧与帧之间的播放间隔会被修正，使其播放总时长与原图一样 | giftimeout | `?iopcmd=thumbnail&type=1&scale=10&gifmode=6` | 缩放GIF动画至原先尺寸的10%，返回在6秒（默认）内处理完成的间隔的帧。假设原图有6帧，每帧播放间隔0.15秒，6秒内只能处理3帧，那么将会返回处理完成的原图的第1、3、5帧。每帧播放间隔将会被修正为0.3秒。 |

## 图片裁剪

| 参数名     | 值                                                                    | 解释                         |
| ------- | -------------------------------------------------------------------- | -------------------------- |
| iopcmd  | crop                                                                 | 主命令                        |
| width   | 0-10000                                                              | 裁剪后宽度                      |
| height  | 0-10000                                                              | 裁剪后高度                      |
| ax      | 0-10000                                                              | 锚点 x 坐标                    |
| ay      | 0-10000                                                              | 锚点 y 坐标                    |
| gravity | NorthWest/North/NorthEast/West Center/East/SouthWest/South/SouthEast | 位置偏移指示符，可以和锚点同时指定(比锚点优先使用) |

## 图片旋转

| 参数名    | 值         | 解释        |
| ------ | --------- | --------- |
| iopcmd | rotate    | 主命令       |
| degree | \[0，360\] | 旋转度数(顺时针) |

## 水印

| 参数名         | 值                                                                    | 解释                                                                         |
| ----------- | -------------------------------------------------------------------- | -------------------------------------------------------------------------- |
| iopcmd      | watermark                                                            | 主命令                                                                        |
| type        | 1=文字水印，2=图片水印                                                        | 水印类型                                                                       |
| gravity     | NorthWest/North/NorthEast/West Center/East/SouthWest/South/SouthEast | 位置偏移指示符，可以和锚点同时指定(比锚点优先使用)                                                 |
| opacity     | 1-100，缺省为 100（完全不透明）                                                  | 透明度                                                                        |
| ax          | 小于原图宽度，默认为 10                                                         | 锚点 x 坐标                                                                    |
| ay          | 小于原图高度，默认为 10                                                         | 锚点 y 坐标                                                                    |
| text        |                                                                      | base64 URL encode 后的水印文字，支持 UTF-8。                                         |
| imageurl    |                                                                      | 可访问的图片资源URI，水印图片，必须是可以访问的资源地址，经过 base64 URL encode。                        |
| font        |                                                                      | base64 URL encode 后的字体名称                                                   |
| fontsize    | 1-100                                                                | 水印文字大小，缺省为10，字体大小。                                                         |
| direction   | 1=RightToLeft，2=LeftToRight                                          | 水印文字方向                                                                     |
| fill        |                                                                      | RGB 颜色编码表，base64 URL encode 后的RGB格式，可以是颜色名称（比如red）或十六进制（比如\#FF0000），缺省为白色。 |
| SimSun      |                                                                      | 宋体                                                                         |
| angle\_type | 1=左上角，2=右上角，3=右下角，4=左下角                                              | 九宫格中水印图片位置，默认为左上角。                                                         |

## 图片格式转换

| 参数名    | 值                | 解释                                                             |
| ------ | ---------------- | -------------------------------------------------------------- |
| iopcmd | convert          | 主命令                                                            |
| dst    | jpg/png/bmp/webp | 目标格式                                                           |
| Q      | 0-100            | 图片压缩质量（绝对压缩比），目标格式为 jpg，webp 时有效                                 |
| q      | 0-100            | 图片压缩质量（相对压缩比），即在图片原有压缩基础上按此比例进行压缩，目标格式为 jpg，webp 时有效，Q 与 q 同时出现时，取 Q |
| fr     | 0.0-1.0          | 需要格式转换的图像帧在图像总帧中的位置，默认为 0.0                                     |

## 管道顺序调用多种图片处理功能

管道顺序是一种可以实现多种图片处理任务顺序执行的机制。用户可以通过管道顺序在一次下载时中按照顺序完成对图像的不同处理。

如：

```
http://demobucket.ufile.ucloud.com.cn/here-for-example.jpg?iopcmd=rotate&degree=180|iopcmd=thumbnail&type=1&scale=40
```

上述请求会将 demobucket 这个空间中的 here-for-example.jpg 文件先旋转 180 度，然后按比例缩放为原来的 40% 大小。

注意：如果请求当前不支持的 iopcmd，则会报错，不会返回原图。
