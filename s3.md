{{indexmenu_n>12}}

# 支持AWS S3 协议说明

### 支持的API

UFile目前的S3协议模块对标准S3协议的支持如下表：

| **API名字**                 | **备注说明**                                                                                                                           |
| ------------------------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| GET Bucket service        | 用于获取Bucket列表，只能获取公私钥或者Token拥有者创建的Bucket                                                                                            |
| GET Bucket location       | 返回所在地域名，不建议依赖该API                                                                                                                  |
| GET Bucket acl            | 没有太多意义，主要为了支持S3 Browser而实现，Permission字段永远为“FULL_CONTROL”                                                                           |
| GET Bucket versioning     | 没有太多意义，主要为了支持S3 Browser而实现，Status字段永远为空字符串                                                                                         |
| GET Object acl            | 没有太多意义，主要为了支持S3 Browser而实现，Permission字段永远为“FULL_CONTROL”                                                                           |
| HEAD Object               | 获取文件元数据信息                                                                                                                          |
| PUT Object                | 参考[UFile S3 兼容API文档-2.0.pdf](http://ufile-release.cn-bj.ufileos.com/UFile%E5%85%BC%E5%AE%B9S3%20API%20-%202.0.pdf)                 |
| POST Object               | 参考[UFile S3 兼容API文档-2.0.pdf](http://ufile-release.cn-bj.ufileos.com/UFile%E5%85%BC%E5%AE%B9S3%20API%20-%202.0.pdf)                 |
| PUT Object copy           | 参考[UFile S3 兼容API文档-2.0.pdf](http://ufile-release.cn-bj.ufileos.com/UFile%E5%85%BC%E5%AE%B9S3%20API%20-%202.0.pdf)                 |
| GET Object                | 参考[UFile S3 兼容API文档-2.0.pdf](http://ufile-release.cn-bj.ufileos.com/UFile%E5%85%BC%E5%AE%B9S3%20API%20-%202.0.pdf)                 |
| List Objects              | 参考[UFile S3 兼容API文档-2.0.pdf](http://ufile-release.cn-bj.ufileos.com/UFile%E5%85%BC%E5%AE%B9S3%20API%20-%202.0.pdf)                 |
| DELETE Object             | 参考[UFile S3 兼容API文档-2.0.pdf](http://ufile-release.cn-bj.ufileos.com/UFile%E5%85%BC%E5%AE%B9S3%20API%20-%202.0.pdf)                 |
| Delete Multiple Objects   | 参考[UFile S3 兼容API文档-2.0.pdf](http://ufile-release.cn-bj.ufileos.com/UFile%E5%85%BC%E5%AE%B9S3%20API%20-%202.0.pdf)                 |
| Initiate Multipart Upload | 参考[UFile S3 兼容API文档-2.0.pdf](http://ufile-release.cn-bj.ufileos.com/UFile%E5%85%BC%E5%AE%B9S3%20API%20-%202.0.pdf)                 |
| Upload Part               | 参考[UFile S3 兼容API文档-2.0.pdf](http://ufile-release.cn-bj.ufileos.com/UFile%E5%85%BC%E5%AE%B9S3%20API%20-%202.0.pdf) , 目前只支持8MB大小的分片 |
| Complete Multipart Upload | 参考[UFile S3 兼容API文档-2.0.pdf](http://ufile-release.cn-bj.ufileos.com/UFile%E5%85%BC%E5%AE%B9S3%20API%20-%202.0.pdf)                 |

注意:

* PUT Object 目前仅支持8MB大小文件，如果需要上传大于8MB的文件，请采用分片上传的API

* POST Object目前仅支持最大32MB文件的上传；

* 目前UFile S3 不支持x-amz-content-sha256(请求内容签名)；

* 目前不支持S3 API的MD5校验(原因跟S3的ETag计算方式有差异)，建议关闭:

      例如AWS S3 Java SDK:
      System.setProperty(SkipMd5CheckStrategy.DISABLEGETOBJECTMD5VALIDATION_PROPERTY,"");
  
      System.setProperty(SkipMd5CheckStrategy.DISABLEPUTOBJECTMD5VALIDATION_PROPERTY,"");

### 仅仅支持签名V4

支持V4签名的场景：

1. URL 中携带参数（URL Query部分的x-amz-credential字段）；

2. POST（表单中x-amz-credential域）;

3. Header 中携带参数（Authorization字段);

### S3的AccessKeyID和SecretAccessKey说明

S3的AccessKeyID(或称AccessKey)和SecretAccessKey(或称SecretKey)对应就是UCloud的API公钥和私钥，或者是UFille服务提供的Token公钥和Token私钥；

#### 注意 要求无论是API公私钥还是Token公私钥，要求操作的bucket，必须满足以下条件:

* 创建该bucke的账户与API公私钥的拥有者必须一致；

* 创建该bucke的账户与创建Token的账户必须一致；

### API支持路径风格和虚拟主机风格

#### 路径风格格式为: http://\${Endpoint}/\${bucket名字}/\${key名字}，bucket名字作为路径使用的一部分;

    例如: AWS S3 Java SDK在UCloud北京地域走外网使用UFile S3服务则设置如下：  
    "AWSCredential credentials = new BasicAWSCredentials(ACCESS_KEY,
    SECRET_KEY);  
    ClientConfiguration clientConfig = new ClientConfiguration();  
    ...  
    S3ClientOptions clientOptions = S3ClientOptions.builder().build();  
    clientOptions.setPathStyleAccess(true); // 表明使用路径风格API  
    AmazonS3 conn = new AmazonS3Client(credential, clientConfig);  
    conn.setS3ClientOptions(clientOptions);  
    conn.setEndpoint("s3-cn-bj.ufileos.com");"

#### 虚拟主机风格: http://${bucket名字}.${Endpoint}/${key名字}，类似UFile目前使用的URL形式；

### 接入域名（Endpoint）

| 地域   | 内网Endpoint                 | 内网Endpoint                          |
| ---- | -------------------------- | ----------------------------------- |
| 北京二  | s3-cn-bj.ufileos.com       | internal.s3-cn-bj.ufileos.com       |
| 上海   | s3-cn-sh2.ufileos.com      | internal.s3-cn-sh2.ufileos.com      |
| 尼日利亚 | s3-afr-nigeria.ufileos.com | internal.s3-afr-nigeria.ufileos.com |
| 浪潮2  | s3.infile.inspurcloud.cn   | s3-internal.infile.inspurcloud.cn   |
| 越南   | s3-vn-sng.ufileos.com      | internal.s3-vn-sng.ufileos.com      |

注意: 目前北京二地域已经支持https协议，其他地域后续支持

### 回调扩展功能支持

| **请求形式 API名字**                  | **PUT Objec** | **POST Object** | **Complete Multipart Upload** |
| ------------------------------- | ------------- | --------------- | ----------------------------- |
| **在 URL 中携带参数**                 | √             | ×               | √                             |
| **在 Header 中携带参数**              | √             | ×               | √                             |
| **在 POST 请求的 body 中使用表单域来携带参数** | ×             | √               | ×                             |

\*) √:支持
×:不支持，具体可以参考[oss文档](https://help.aliyun.com/document_detail/31989.html?spm=5176.11065259.1996646101.searchclickresult.2f4f2ddaVvnuBz)，但相关参数需要做替换:

| **oss回调参数**        | **UFile S3 回调参数**    |
| ------------------ | -------------------- |
| x-oss-callback     | x-ufile-callback     |
| x-oss-callback-var | x-ufile-callback-var |

### 图片操作支持

参考[UFile官方文档图片处理服务](https://docs.ucloud.cn/storage_cdn/ufile/pic)


